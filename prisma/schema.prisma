// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model WaterSource {
  id          String          @id @default(cuid())
  brand       String
  productName String
  origin      String?
  barcode     String?         @unique
  analyses    WaterAnalysis[]
  scans       ScanResult[]
  createdAt   DateTime        @default(now())

  @@index([barcode])
  @@index([brand, productName])
  @@index([createdAt])
}

model WaterAnalysis {
  id                     String       @id @default(cuid())
  waterSourceId          String
  waterSource            WaterSource  @relation(fields: [waterSourceId], references: [id])
  scanResults            ScanResult[]
  analysisDate           DateTime?
  sourceType             String       // "manufacturer" | "authority" | "user" | "api"
  reliabilityScore       Float        // 0â€“1
  ph                     Float?
  calcium                Float?
  magnesium              Float?
  sodium                 Float?
  potassium              Float?
  chloride               Float?
  sulfate                Float?
  bicarbonate            Float?
  nitrate                Float?
  fluoride               Float?
  totalDissolvedSolids   Float?
  createdAt              DateTime     @default(now())

  @@index([waterSourceId, createdAt])
  @@index([sourceType])
  @@index([reliabilityScore])
}

model ScanResult {
  id              String        @id @default(cuid())
  timestamp       DateTime      @default(now())
  barcode         String?
  profile         String        // "standard" | "baby" | "sport" | "blood_pressure"
  score           Float?
  metricScores    Json?         // { ph: 80, sodium: 20, ... }
  ocrTextRaw      String?
  ocrParsedValues Json?
  userOverrides   Json?

  waterSourceId   String?
  waterSource     WaterSource?  @relation(fields: [waterSourceId], references: [id])

  waterAnalysisId String?
  waterAnalysis   WaterAnalysis? @relation(fields: [waterAnalysisId], references: [id])

  @@index([timestamp])
  @@index([profile])
  @@index([waterSourceId])
  @@index([barcode])
  @@index([score])
}
